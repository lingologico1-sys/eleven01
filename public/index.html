<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElevenLabs V3 Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #0a0a0b; --surface: #141416; --surface-2: #1c1c20; --surface-3: #24242a;
            --border: #2a2a32; --border-hover: #3a3a44;
            --text: #e8e8ec; --text-muted: #8888a0; --text-dim: #5c5c72;
            --accent: #6c5ce7; --accent-glow: rgba(108,92,231,0.15); --accent-hover: #7d6ff0;
            --success: #00d68f; --success-bg: rgba(0,214,143,0.08);
            --error: #ff6b6b; --error-bg: rgba(255,107,107,0.08);
            --radius: 10px; --radius-lg: 16px;
        }

        body {
            font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text);
            min-height: 100vh; display: flex; align-items: flex-start; justify-content: center;
            padding: 40px 20px 60px; -webkit-font-smoothing: antialiased;
        }

        body::before {
            content: ''; position: fixed; inset: 0;
            background-image: linear-gradient(rgba(108,92,231,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(108,92,231,0.03) 1px, transparent 1px);
            background-size: 60px 60px; pointer-events: none; z-index: 0;
        }

        /* Auth */
        .auth-overlay { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: var(--bg); padding: 20px; }
        .auth-overlay.hidden { display: none; }
        .auth-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 40px 32px; width: 100%; max-width: 360px; text-align: center; animation: fadeUp 0.4s ease-out; }
        .auth-icon { margin-bottom: 20px; }
        .auth-title { font-size: 20px; font-weight: 600; margin-bottom: 24px; }
        .auth-field { margin-bottom: 16px; }
        .auth-field input { width: 100%; background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px 14px; font-size: 15px; font-family: 'DM Sans', sans-serif; color: var(--text); outline: none; text-align: center; letter-spacing: 2px; transition: border-color 0.2s, box-shadow 0.2s; }
        .auth-field input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .auth-field input::placeholder { color: var(--text-dim); letter-spacing: 0; }
        .auth-btn { width: 100%; justify-content: center; }
        .auth-error { margin-top: 14px; font-size: 13px; color: var(--error); min-height: 20px; }

        /* App */
        .container { width: 100%; max-width: 560px; position: relative; z-index: 1; animation: fadeUp 0.5s ease-out; }
        .header { margin-bottom: 32px; }
        .header h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 6px; background: linear-gradient(135deg, var(--text), var(--text-muted)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header p { font-size: 14px; color: var(--text-dim); }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 28px; margin-bottom: 16px; transition: border-color 0.2s; }
        .card:hover { border-color: var(--border-hover); }
        .card-label { font-size: 11px; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 18px; }
        .field { margin-bottom: 20px; }
        .field:last-child { margin-bottom: 0; }
        .field-label { display: flex; justify-content: space-between; align-items: center; font-size: 13px; font-weight: 500; color: var(--text-muted); margin-bottom: 8px; }
        .field-label .value { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent); font-weight: 500; }

        input[type="text"], textarea { width: 100%; background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px 14px; font-size: 14px; font-family: 'JetBrains Mono', monospace; color: var(--text); outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
        input[type="text"]:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        input[type="text"]::placeholder, textarea::placeholder { color: var(--text-dim); }
        textarea { height: 110px; resize: vertical; font-family: 'DM Sans', sans-serif; line-height: 1.6; }

        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 4px; background: var(--surface-3); border-radius: 2px; outline: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--accent); border: 3px solid var(--surface); box-shadow: 0 0 0 1px var(--accent); cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.15); box-shadow: 0 0 0 1px var(--accent), 0 0 12px var(--accent-glow); }
        input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: var(--accent); border: 3px solid var(--surface); box-shadow: 0 0 0 1px var(--accent); cursor: pointer; }

        .checkbox-wrap { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; color: var(--text-muted); user-select: none; }
        .checkbox-wrap input[type="checkbox"] { display: none; }
        .checkbox-box { width: 20px; height: 20px; border-radius: 6px; border: 1.5px solid var(--border); background: var(--surface-2); display: flex; align-items: center; justify-content: center; transition: all 0.15s; flex-shrink: 0; }
        .checkbox-box svg { opacity: 0; transform: scale(0.5); transition: all 0.15s; }
        .checkbox-wrap input:checked + .checkbox-box { background: var(--accent); border-color: var(--accent); }
        .checkbox-wrap input:checked + .checkbox-box svg { opacity: 1; transform: scale(1); }

        .actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; border: none; border-radius: var(--radius); font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; outline: none; }
        .btn-primary { background: var(--accent); color: #fff; box-shadow: 0 2px 12px var(--accent-glow); }
        .btn-primary:hover:not(:disabled) { background: var(--accent-hover); box-shadow: 0 4px 20px rgba(108,92,231,0.25); transform: translateY(-1px); }
        .btn-primary:active:not(:disabled) { transform: translateY(0); }
        .btn-secondary { background: var(--surface-2); color: var(--text-muted); border: 1px solid var(--border); }
        .btn-secondary:hover:not(:disabled) { background: var(--surface-3); color: var(--text); border-color: var(--border-hover); }
        .btn:disabled { opacity: 0.35; cursor: not-allowed; }
        .btn-icon { background: transparent; border: none; color: var(--text-dim); padding: 6px; cursor: pointer; border-radius: 6px; transition: color 0.2s, background 0.2s; display: flex; align-items: center; }
        .btn-icon:hover { color: var(--error); background: var(--error-bg); }

        .status-bar { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 16px; font-size: 13px; color: var(--text-dim); display: flex; align-items: center; gap: 10px; transition: all 0.3s; }
        .status-bar.error { color: var(--error); background: var(--error-bg); border-color: rgba(255,107,107,0.15); }
        .status-bar.success { color: var(--success); background: var(--success-bg); border-color: rgba(0,214,143,0.15); }
        .status-bar .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-dim); flex-shrink: 0; }
        .status-bar.error .dot { background: var(--error); }
        .status-bar.success .dot { background: var(--success); }
        .status-bar.loading .dot { background: var(--accent); animation: pulse-dot 1.2s ease-in-out infinite; }

        @keyframes pulse-dot { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(0.7); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-6px); } 40%, 80% { transform: translateX(6px); } }
        .shake { animation: shake 0.4s ease; }

        @media (max-width: 480px) { body { padding: 20px 12px 40px; } .card { padding: 20px; } .header h1 { font-size: 22px; } .actions { flex-direction: column; } .btn { justify-content: center; } }
    </style>
</head>
<body>

    <!-- Password Gate -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-card" id="auth-card">
            <div class="auth-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/><circle cx="12" cy="16" r="1"/></svg>
            </div>
            <h2 class="auth-title">Enter Password</h2>
            <div class="auth-field">
                <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password" />
            </div>
            <button class="btn btn-primary auth-btn" id="auth-submit">Unlock</button>
            <div class="auth-error" id="auth-error"></div>
        </div>
    </div>

    <!-- Main App -->
    <div class="container" id="main-app" style="display:none;">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>ElevenLabs V3</h1>
                <div style="display:flex; gap:4px;">
                    <button class="btn-icon" id="btn-logout" title="Lock">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    </button>
                    <button class="btn-icon" id="btn-reset" title="Reset to defaults">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>
                    </button>
                </div>
            </div>
            <p>Text-to-speech with timestamps</p>
        </div>

        <div class="card">
            <div class="card-label">Input</div>
            <div class="field">
                <div class="field-label"><span>Voice ID</span></div>
                <input type="text" id="voiceId" value="JBFqnCBsd6RMkjVDRZzb" placeholder="e.g., JBFqnCBsd6RMkjVDRZzb" spellcheck="false" />
            </div>
            <div class="field">
                <div class="field-label"><span>Text</span></div>
                <textarea id="text" placeholder="Enter text to synthesize...">Hello world! This is ElevenLabs V3.</textarea>
            </div>
        </div>

        <div class="card">
            <div class="card-label">Voice Settings</div>
            <div class="field">
                <div class="field-label"><span>Stability</span><span class="value" id="val-stability">0.50</span></div>
                <input type="range" id="stability" min="0" max="1" step="0.01" value="0.5" />
            </div>
            <div class="field">
                <div class="field-label"><span>Similarity Boost</span><span class="value" id="val-similarity">0.75</span></div>
                <input type="range" id="similarity_boost" min="0" max="1" step="0.01" value="0.75" />
            </div>
            <div class="field">
                <div class="field-label"><span>Style Exaggeration</span><span class="value" id="val-style">0.00</span></div>
                <input type="range" id="style" min="0" max="1" step="0.01" value="0.0" />
            </div>
            <div class="field">
                <label class="checkbox-wrap">
                    <input type="checkbox" id="use_speaker_boost" checked />
                    <span class="checkbox-box">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                    </span>
                    Speaker Boost
                </label>
            </div>
        </div>

        <div class="card">
            <div class="actions">
                <button class="btn btn-primary" id="btn-generate">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    Generate
                </button>
                <button class="btn btn-secondary" id="btn-play" disabled>
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    <span id="play-label">Play</span>
                </button>
                <button class="btn btn-secondary" id="btn-dl-audio" disabled>
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    MP3
                </button>
                <button class="btn btn-secondary" id="btn-dl-json" disabled>
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    JSON
                </button>
            </div>
        </div>

        <div class="status-bar" id="status">
            <span class="dot"></span>
            <span id="status-text">Ready</span>
        </div>
        <audio id="audio-player" style="display:none;"></audio>
    </div>

    <script>
        const SESSION_KEY = 'el_session';
        const getToken = () => localStorage.getItem(SESSION_KEY);
        const setToken = t => localStorage.setItem(SESSION_KEY, t);
        const clearToken = () => localStorage.removeItem(SESSION_KEY);

        async function checkAuth() {
            const t = getToken();
            if (!t) return false;
            try { const r = await fetch('/api/auth/verify', { headers: { Authorization: 'Bearer ' + t } }); return r.ok; } catch { return false; }
        }

        async function login(pw) {
            const r = await fetch('/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: pw }) });
            if (!r.ok) return false;
            const d = await r.json();
            setToken(d.token);
            return true;
        }

        function showApp() { document.getElementById('auth-overlay').classList.add('hidden'); document.getElementById('main-app').style.display = ''; }
        function showLogin() { clearToken(); document.getElementById('auth-overlay').classList.remove('hidden'); document.getElementById('main-app').style.display = 'none'; document.getElementById('auth-password').value = ''; document.getElementById('auth-error').textContent = ''; }

        const authPw = document.getElementById('auth-password');
        const authBtn = document.getElementById('auth-submit');
        const authErr = document.getElementById('auth-error');
        const authCard = document.getElementById('auth-card');

        async function handleLogin() {
            if (!authPw.value) { authErr.textContent = 'Please enter a password'; return; }
            authBtn.disabled = true; authBtn.textContent = 'Checking…'; authErr.textContent = '';
            const ok = await login(authPw.value);
            authBtn.disabled = false; authBtn.textContent = 'Unlock';
            if (ok) { showApp(); } else { authErr.textContent = 'Wrong password'; authCard.classList.remove('shake'); void authCard.offsetWidth; authCard.classList.add('shake'); }
        }

        authBtn.addEventListener('click', handleLogin);
        authPw.addEventListener('keydown', e => { if (e.key === 'Enter') handleLogin(); });

        // ---- Main App ----
        let audioBase64 = null, alignmentData = null;
        const defaults = { voiceId: 'JBFqnCBsd6RMkjVDRZzb', text: 'Hello world! This is ElevenLabs V3.', stability: 0.5, similarity_boost: 0.75, style: 0.0, use_speaker_boost: true };
        const $ = id => document.getElementById(id);

        const voiceIdEl = $('voiceId'), textEl = $('text'), stabilityEl = $('stability'), similarityEl = $('similarity_boost'), styleEl = $('style'), speakerBoostEl = $('use_speaker_boost');
        const btnGenerate = $('btn-generate'), btnPlay = $('btn-play'), btnDlAudio = $('btn-dl-audio'), btnDlJson = $('btn-dl-json'), btnReset = $('btn-reset'), btnLogout = $('btn-logout');
        const statusBar = $('status'), statusText = $('status-text'), playLabel = $('play-label'), audioPlayer = $('audio-player');

        stabilityEl.addEventListener('input', () => $('val-stability').textContent = parseFloat(stabilityEl.value).toFixed(2));
        similarityEl.addEventListener('input', () => $('val-similarity').textContent = parseFloat(similarityEl.value).toFixed(2));
        styleEl.addEventListener('input', () => $('val-style').textContent = parseFloat(styleEl.value).toFixed(2));

        function saveSettings() { try { localStorage.setItem('elevenlabs_settings', JSON.stringify(getSettings())); } catch(e) {} }
        function loadSettings() { try { const s = localStorage.getItem('elevenlabs_settings'); if (s) applySettings(JSON.parse(s)); } catch(e) {} }
        function getSettings() { return { voiceId: voiceIdEl.value, text: textEl.value, stability: parseFloat(stabilityEl.value), similarity_boost: parseFloat(similarityEl.value), style: parseFloat(styleEl.value), use_speaker_boost: speakerBoostEl.checked }; }
        function applySettings(s) {
            if (!s) return;
            if (s.voiceId !== undefined) voiceIdEl.value = s.voiceId;
            if (s.text !== undefined) textEl.value = s.text;
            if (s.stability !== undefined) { stabilityEl.value = s.stability; $('val-stability').textContent = parseFloat(s.stability).toFixed(2); }
            if (s.similarity_boost !== undefined) { similarityEl.value = s.similarity_boost; $('val-similarity').textContent = parseFloat(s.similarity_boost).toFixed(2); }
            if (s.style !== undefined) { styleEl.value = s.style; $('val-style').textContent = parseFloat(s.style).toFixed(2); }
            if (s.use_speaker_boost !== undefined) speakerBoostEl.checked = s.use_speaker_boost;
        }

        [voiceIdEl, textEl, stabilityEl, similarityEl, styleEl, speakerBoostEl].forEach(el => { el.addEventListener('input', saveSettings); el.addEventListener('change', saveSettings); });

        function setStatus(msg, type = '') { statusText.textContent = msg; statusBar.className = 'status-bar' + (type ? ' ' + type : ''); }
        function updateButtons() { const has = !!audioBase64; btnPlay.disabled = !has; btnDlAudio.disabled = !has; btnDlJson.disabled = !alignmentData ? true : !has; }

        btnGenerate.addEventListener('click', async () => {
            const s = getSettings();
            if (!s.text.trim() || !s.voiceId.trim()) { setStatus('Voice ID and text are required', 'error'); return; }
            btnGenerate.disabled = true; setStatus('Generating audio…', 'loading');
            try {
                const res = await fetch('/api/generate', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + (getToken() || '') }, body: JSON.stringify(s) });
                if (res.status === 401) { showLogin(); return; }
                if (!res.ok) { const e = await res.json().catch(() => ({ error: `HTTP ${res.status}` })); throw new Error(e.error || `Request failed: ${res.status}`); }
                const data = await res.json();
                audioBase64 = data.audio_base64; alignmentData = data.alignment || null;
                audioPlayer.src = 'data:audio/mpeg;base64,' + audioBase64;
                setStatus('Audio generated successfully', 'success'); updateButtons();
            } catch (err) { console.error(err); setStatus(err.message || 'Failed to generate audio', 'error'); }
            finally { btnGenerate.disabled = false; }
        });

        btnPlay.addEventListener('click', () => { if (audioPlayer.src) { audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause(); } });
        audioPlayer.addEventListener('play', () => playLabel.textContent = 'Pause');
        audioPlayer.addEventListener('pause', () => playLabel.textContent = 'Play');
        audioPlayer.addEventListener('ended', () => playLabel.textContent = 'Play');

        btnDlAudio.addEventListener('click', () => { if (!audioBase64) return; const a = document.createElement('a'); a.href = 'data:audio/mpeg;base64,' + audioBase64; a.download = 'elevenlabs_v3_' + Date.now() + '.mp3'; a.click(); });
        btnDlJson.addEventListener('click', () => { if (!alignmentData) return; const a = document.createElement('a'); a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(alignmentData, null, 2)); a.download = 'timestamps_' + Date.now() + '.json'; a.click(); });
        btnReset.addEventListener('click', () => { applySettings(defaults); saveSettings(); audioBase64 = null; alignmentData = null; audioPlayer.src = ''; playLabel.textContent = 'Play'; updateButtons(); setStatus('Reset to defaults', ''); });
        btnLogout.addEventListener('click', () => showLogin());

        loadSettings();
        (async () => { if (await checkAuth()) showApp(); else { showLogin(); authPw.focus(); } })();
    </script>
</body>
</html>
